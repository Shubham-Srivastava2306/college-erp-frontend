<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Management</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
      <h2>Admin</h2>
      <a href="admin-dashboard.html">Dashboard</a>
      <a href="students.html">Manage Students</a>
      <a class="active" href="faculty.html">Manage Faculty</a>
      <a href="assign-subjects.html">Assign Subjects</a>
      <a href="timetable.html">Manage Timetable</a>
      <a href="notice.html">Manage Notices</a>
      <a href="../index.html">Logout</a>
  </div>

  <!-- Main Content -->
  <div class="content">
      <h1>Manage Faculty</h1>

      <!-- Add Faculty Form -->
      <div class="card">
          <h3>Add New Faculty</h3>
          <form id="addFacultyForm">
              <input type="text" id="name" placeholder="Name" required />
              <input type="email" id="email" placeholder="Email" required />
              <input type="text" id="department" placeholder="Department" required />
              <input type="password" id="password" placeholder="Password" required />
              <input type="text" id="subjects" placeholder="Subjects (comma-separated)" required />
              <button type="submit">Add Faculty</button>
          </form>
      </div>

      <!-- Faculty Table -->
      <div class="card">
          <h3>Registered Faculty</h3>
          <table>
              <thead>
                  <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Department</th>
                      <th>Subjects</th>
                      <th>Actions</th>
                  </tr>
              </thead>
              <tbody id="facultyTable">
                  <!-- Dynamic rows will be added here -->
              </tbody>
          </table>
      </div>
  </div>

  <script>
const token = localStorage.getItem('token');

// Redirect if token missing
if (!token) {
    alert("You must login first!");
    window.location.href = "../login.html";
}

const form = document.getElementById('addFacultyForm');
const facultyTable = document.getElementById('facultyTable');

// Fetch all faculty
async function loadFaculty() {
    try {
        const res = await fetch('http://localhost:5000/api/admin/all-faculty', {
            headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        // Handle invalid token or authorization failure
        if (!data.success) {
            alert(data.message || "Failed to load faculty. Please login again.");
            localStorage.removeItem("token");
            window.location.href = "../login.html";
            return;
        }

        facultyTable.innerHTML = '';
        data.faculty.forEach(f => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${f.name}</td>
                <td>${f.email}</td>
                <td>${f.department}</td>
                <td>${f.subjects.join(', ')}</td>
                <td>
                    <button class="edit" data-id="${f._id}">Edit</button>
                    <button class="delete" data-id="${f._id}">Delete</button>
                </td>
            `;
            facultyTable.appendChild(tr);
        });

        attachDeleteHandlers();

    } catch (err) {
        alert('Failed to load faculty: ' + err.message);
    }
}

// Add new faculty
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const subjects = document.getElementById('subjects').value.split(',').map(s => s.trim());

    try {
        const res = await fetch('http://localhost:5000/api/admin/add-faculty', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                department: document.getElementById('department').value,
                password: document.getElementById('password').value,
                subjects
            })
        });

        const data = await res.json();

        if (!data.success) {
            alert(data.message || "Failed to add faculty.");
            return;
        }

        alert(data.message);
        form.reset();
        loadFaculty();

    } catch (err) {
        alert('Error adding faculty: ' + err.message);
    }
});

// Delete faculty
function attachDeleteHandlers() {
    const deleteButtons = document.querySelectorAll('.delete');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            if (!confirm('Are you sure you want to delete this faculty?')) return;

            try {
                const res = await fetch(`http://localhost:5000/api/admin/delete-faculty/${id}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                });

                const data = await res.json();

                if (!data.success) {
                    alert(data.message || "Failed to delete faculty.");
                    return;
                }

                alert(data.message);
                loadFaculty();

            } catch (err) {
                alert('Error deleting faculty: ' + err.message);
            }
        });
    });
}

// Initial load
loadFaculty();
</script>


</body>
</html>
