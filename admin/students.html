<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students Management</title>
    <link rel="stylesheet" href="admin.css" />
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
      <h2>Admin</h2>
      <a href="admin-dashboard.html">Dashboard</a>
      <a class="active" href="students.html">Manage Students</a>
      <a href="faculty.html">Manage Faculty</a>
      <a href="assign-subjects.html">Assign Subjects</a>
      <a href="timetable.html">Manage Timetable</a>
      <a href="notice.html">Manage Notices</a>
      <a href="../login.html">Logout</a>
  </div>

  <!-- Main Content -->
  <div class="content">
      <h1>Manage Students</h1>

      <!-- Add Student Form -->
      <div class="card">
          <h3>Add New Student</h3>
          <form id="studentForm">
              <input type="text" id="name" placeholder="Student Name" required>
              <input type="email" id="email" placeholder="Email" required>
              <input type="text" id="rollNo" placeholder="Roll No" required>
              <input type="text" id="department" placeholder="Department" required>
              <input type="password" id="password" placeholder="Password" required>
              <button type="submit">Add Student</button>
          </form>
      </div>

      <!-- Student Table -->
      <div class="card">
          <h3>Registered Students</h3>
          <table>
              <thead>
                  <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Roll No</th>
                      <th>Department</th>
                      <th>Actions</th>
                  </tr>
              </thead>
              <tbody id="studentTable">
                  <!-- Dynamic rows will be added here -->
              </tbody>
          </table>
      </div>
  </div>

  <script>
const token = localStorage.getItem('token');

// Redirect if no token
if (!token) {
    alert("You must login first!");
    window.location.href = "../login.html";
}

const studentForm = document.getElementById('studentForm');
const studentTable = document.getElementById('studentTable');

// Fetch all students and populate table
async function loadStudents() {
    try {
        const res = await fetch('http://localhost:5000/api/admin/all-students', {
            headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        // If token invalid or session expired
        if (!data.success) {
            alert(data.message || "Failed to load students. Please login again.");
            localStorage.removeItem("token");
            window.location.href = "../login.html";
            return;
        }

        studentTable.innerHTML = '';
        data.students.forEach(student => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${student.name}</td>
                <td>${student.email}</td>
                <td>${student.rollNo}</td>
                <td>${student.department}</td>
                <td>
                    <button class="edit" data-id="${student._id}">Edit</button>
                    <button class="delete" data-id="${student._id}">Delete</button>
                </td>
            `;
            studentTable.appendChild(tr);
        });

        attachDeleteHandlers();

    } catch (err) {
        alert('Failed to load students: ' + err.message);
    }
}

// Add new student
studentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
        const res = await fetch('http://localhost:5000/api/admin/add-student', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`
            },
            body: JSON.stringify({
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                rollNo: document.getElementById('rollNo').value,
                department: document.getElementById('department').value,
                password: document.getElementById('password').value
            })
        });

        const data = await res.json();

        if (!data.success) {
            alert(data.message || "Failed to add student.");
            return;
        }

        alert(data.message);
        studentForm.reset();
        loadStudents();

    } catch (err) {
        alert('Error adding student: ' + err.message);
    }
});

// Delete student
function attachDeleteHandlers() {
    const deleteButtons = document.querySelectorAll('.delete');
    deleteButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if (!confirm('Are you sure you want to delete this student?')) return;

            try {
                const res = await fetch(`http://localhost:5000/api/admin/delete-student/${id}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                });

                const data = await res.json();

                if (!data.success) {
                    alert(data.message || "Failed to delete student.");
                    return;
                }

                alert(data.message);
                loadStudents();

            } catch (err) {
                alert('Error deleting student: ' + err.message);
            }
        });
    });
}

// Initial load
loadStudents();
</script>


</body>
</html>
